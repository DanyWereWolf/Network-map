/**
 * Модальное окно справки
 */
function openHelpModal() {
    var modal = document.getElementById('helpModal');
    var content = document.getElementById('helpModalContent');
    if (modal && content) {
        content.innerHTML = getHelpContentHtml();
        modal.style.display = 'block';
    }
}

function closeHelpModal() {
    var modal = document.getElementById('helpModal');
    if (modal) modal.style.display = 'none';
}

function getHelpContentHtml() {
    return '<div class="help-section">' +
        '<h3>О программе</h3>' +
        '<p><strong>Карта локальной сети</strong> — веб-приложение для визуализации и управления сетевой инфраструктурой на базе Яндекс.Карт. Позволяет отображать узлы, кроссы, муфты, опоры и кабели, прокладывать трассы и отслеживать соединения жил.</p>' +
        '</div>' +
        '<div class="help-section"><h3>Режимы работы</h3><ul>' +
        '<li><strong>Просмотр</strong> — навигация по карте, клик по объектам для просмотра информации, трассировка жил. Редактирование недоступно.</li>' +
        '<li><strong>Редактирование</strong> — всё то же плюс добавление/удаление объектов, прокладка кабелей, соединение жил в кроссах и муфтах, подключение жил к узлам. Доступно только пользователям с правами редактора.</li>' +
        '</ul></div>' +
        '<div class="help-section"><h3>Типы объектов</h3><ul>' +
        '<li><strong>Узел сети</strong> — конечное сетевое устройство (сервер, коммутатор). К узлам подключаются жилы из кроссов.</li>' +
        '<li><strong>Оптический кросс</strong> — точка коммутации: соединение жил между кабелями и вывод жил на узлы сети.</li>' +
        '<li><strong>Кабельная муфта</strong> — сращивание кабелей: соединение жил между кабелями (без вывода на узлы). Тип муфты задаётся при создании (вместимость по волокнам).</li>' +
        '<li><strong>Опора связи</strong> — промежуточная точка для воздушных линий; кабель проходит транзитом.</li>' +
        '<li><strong>Кабель</strong> — оптический (4/8/16/24 жилы) или медный; соединяет два объекта (муфта, кросс, узел, опора).</li>' +
        '</ul></div>' +
        '<div class="help-section"><h3>Как пользоваться</h3>' +
        '<h4>Добавление объектов</h4><p>В режиме редактирования выберите тип объекта в боковой панели (Узлы, Кроссы, Муфты, Опоры), при необходимости укажите тип муфты или название группы, затем кликните по карте в нужном месте.</p>' +
        '<h4>Прокладка кабеля</h4><p>Нажмите «Проложить кабель», выберите тип кабеля, затем кликните по первому объекту (муфта, кросс, узел или опора), затем по второму. Кабель появится между ними.</p>' +
        '<h4>Соединение жил в кроссе</h4><p>Откройте карточку кросса (клик по объекту). В блоке «Управление жилами в кроссе» можно: соединить две жилы из разных кабелей (выбрать первую, затем вторую); подключить жилу к узлу сети (кнопка «Подключить к узлу»); отключить жилу от узла (кнопка «✕» в режиме редактирования).</p>' +
        '<h4>Соединение жил в муфте</h4><p>В карточке муфты отображается блок «Объединение жил в муфте». Выберите жилу одного кабеля, затем жилу другого — они соединятся. Одна жила может быть соединена только с одной жилой из другого кабеля.</p>' +
        '<h4>Группы кроссов и узлов</h4><p>Несколько кроссов или узлов в одной точке объединяются в группу. При клике по группе открывается баллун со списком: выбор объекта для просмотра или (в режиме редактирования) для прокладки кабеля. Название группы можно изменить; объект можно вынести из группы кнопкой «Переместить».</p>' +
        '</div>' +
        '<div class="help-section"><h3>Поиск и интерфейс</h3><ul>' +
        '<li><strong>Поиск</strong> — поле в шапке: введите название или часть названия объекта, выберите результат — карта центрируется на объекте.</li>' +
        '<li><strong>Легенда</strong> — в боковой панели: условные обозначения типов объектов и кабелей.</li>' +
        '<li><strong>Тема</strong> — кнопка солнца/луны рядом с пользователем: переключение светлой и тёмной темы.</li>' +
        '<li><strong>Экспорт / Импорт</strong> — сохранение карты в JSON и загрузка из файла (в боковой панели).</li>' +
        '<li><strong>Импорт из NetBox</strong> — загрузка устройств из NetBox API по настроенному URL и токену.</li>' +
        '</ul></div>' +
        '<div class="help-section"><h3>Роли</h3><ul>' +
        '<li><strong>Администратор</strong> — полный доступ: редактирование, управление пользователями, история изменений.</li>' +
        '<li><strong>Пользователь</strong> — просмотр карты, информация об объектах, трассировка; без редактирования.</li>' +
        '</ul></div>' +
        '<div class="help-section"><h3>Горячие клавиши</h3><ul>' +
        '<li><kbd>Escape</kbd> — отмена текущей операции (например, прокладки кабеля).</li>' +
        '<li><kbd>Delete</kbd> — удаление выбранного объекта (в режиме редактирования).</li>' +
        '</ul></div>' +
        '<div class="help-section"><h3>Хранение данных</h3>' +
        '<p>Данные хранятся в браузере (localStorage): объекты карты, пользователи, сессия, история изменений, тема. Для переноса данных используйте экспорт и импорт.</p></div>' +
        '<div class="help-section"><h3>Обновления</h3>' +
        '<p>Нажмите кнопку со стрелкой вниз в шапке (рядом со справкой) — откроется окно <strong>Обновления</strong>. Там можно проверить версию: если доступна новая — текущая версия подсвечивается красным и есть ссылка на загрузку; если установлена последняя — зелёным.</p></div>';
}

function setupHelpModalHandlers() {
    var closeBtn = document.querySelector('.close-help');
    if (closeBtn) closeBtn.addEventListener('click', closeHelpModal);
    var modal = document.getElementById('helpModal');
    if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) closeHelpModal(); });
}
