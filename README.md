# Карта локальной сети

Веб-приложение для визуализации и управления сетевой инфраструктурой на базе Яндекс.Карт. Одна карта на всех: данные и синхронизация через единый сервер.

**Версия:** 1.0.3

## Возможности

- **Визуализация** — узлы, оптические кроссы, кабельные муфты, опоры связи и кабели на карте
- **Трассировка жил** — путь оптического волокна от узла до узла через муфты и кроссы
- **Редактирование** — добавление и удаление объектов, прокладка кабелей, соединение жил в кроссах и муфтах
- **Кабели** — прокладка от муфты/кросса до муфты/кросса с опорами как промежуточными точками; один кабель — одна полилиния
- **Группы** — объединение нескольких кроссов или узлов в одной точке
- **Поиск** — по названию в шапке, центрирование на объекте
- **Фильтр карты** — показ только выбранных типов (узлы, кроссы, муфты, опоры); кабели отображаются только между видимыми объектами
- **Экспорт / Импорт** — JSON; импорт из NetBox по API
- **Авторизация** — администратор (полный доступ) и пользователь (только просмотр)
- **История изменений** — журнал действий с фильтрами по пользователю, типу действия и датам; бейдж непрочитанных в шапке
- **Типы узлов** — настраиваемый тип узла сети (обычный / агрегации) с разными цветами и отображением цветов внутри группы узлов
- **Начальная позиция карты** — каждый пользователь может сохранить текущий вид как начальный (при открытии карта открывается в «своём» городе/районе)
- **Интерфейс карты** — складывающаяся левая панель с кнопкой-стрелкой; при скрытии панель освобождает место под карту
- **Тема** — светлая и тёмная (интерфейс и подложка карты)
- **Синхронизация** — совместная работа в реальном времени (пооперационная, как Эсборд), курсоры участников
- **Хранение** — карта, пользователи, история, настройки на сервере (файл `data/store.json`)
- **Резервные копии** — автоматическое ежедневное сохранение в `data/backups/` с датой в имени файла; хранятся 30 дней, старые удаляются

## Быстрый старт

1. Установите зависимости: `npm install`
2. Запустите сервер: `npm run api` (порт 3000 по умолчанию)
3. Откройте в браузере **http://localhost:3000**
4. Войдите (по умолчанию: `admin` / `admin123`)
5. В блоке **Синхронизация** нажмите **Подключиться** — карта загрузится и будет синхронизироваться с сервером
6. Переключитесь в режим **Редактирование** для добавления объектов и прокладки кабелей

Без сервера приложение не работает: при открытии показывается предложение подключиться к серверу.

## Режимы и объекты

| Режим | Описание |
|-------|----------|
| **Просмотр** | Навигация, клик по объектам — информация и трассировка. Редактирование недоступно. |
| **Редактирование** | Добавление/удаление объектов, прокладка кабелей, соединение жил. Только для пользователей с правами редактора. |

| Тип объекта | Назначение |
|-------------|------------|
| Узел сети | Конечное устройство; подключаются жилы из кроссов |
| Оптический кросс | Соединение жил между кабелями и вывод на узлы |
| Кабельная муфта | Сращивание жил между кабелями |
| Опора связи | Транзитная точка (воздушные линии) |
| Кабель | ВОЛС 4/8/16/24 жилы (от муфты/кросса до муфты/кросса, опоры — промежуточные точки) |

Добавление: в режиме редактирования выберите тип в боковой панели и кликните по карте. Прокладка кабеля: **Проложить кабель** → выберите тип → клик по начальной точке (муфта или кросс), при необходимости добавьте опоры, затем по конечной (муфта или кросс).

В карточке объекта доступны **Удалить** и **Дублировать** (в режиме редактирования). При удалении опоры, через которую проложен кабель, показывается предупреждение; кабель удаляется вместе с опорой.

## Горячие клавиши

| Клавиша | Действие |
|---------|----------|
| `Escape` | Отмена текущей операции (режим размещения, прокладка кабеля) |

## Синхронизация

- Сервер: тот же процесс, что и REST API (`npm run api`). WebSocket: путь `/sync`, по умолчанию тот же хост (например `ws://localhost:3000/sync`).
- При подключении клиент получает текущее состояние карты; дальнейшие изменения передаются операциями (без перезагрузки всей карты).
- В блоке синхронизации отображается список «В сети»; на карте видны курсоры других участников.

Отдельный старый сервер только синхронизации: `npm run sync` (server.js) — для сценариев без REST API.

## Хранение данных

- Всё хранится на сервере в `data/store.json` (карта, пользователи, сессии, история, настройки).
- Запускайте один экземпляр сервера (`npm run api`).
- **Резервные копии:** сервер раз в сутки сохраняет полную копию в `data/backups/backup-YYYY-MM-DD.json`. Хранятся последние 30 дней, более старые удаляются автоматически. Восстановление: скопировать нужный файл в `data/store.json` (при остановленном сервере). Дополнительно можно использовать **Экспорт** в приложении.

### Настройка сервера

Скопируйте `server-config.example.json` в `server-config.json`. Параметры:

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `port` | 3000 | Порт |
| `host` | "0.0.0.0" | `0.0.0.0` — доступ по localhost и по IP в сети |

Переменные окружения `PORT` и `HOST` переопределяют файл.

## Структура проекта

```
├── index.html          # Главная страница
├── auth.html            # Страница входа
├── main.js              # Карта, объекты, кабели, UI
├── auth.js              # Авторизация
├── styles.css, auth.css # Стили
├── js/
│   ├── config.js        # Версия, репозиторий (для обновлений)
│   ├── utils.js         # escapeHtml, getObjectTypeName
│   ├── notifications.js # Уведомления (toast)
│   ├── updates.js       # Проверка обновлений
│   ├── help.js          # Справка
│   ├── history.js       # История изменений
│   └── sync.js          # WebSocket-синхронизация карты
├── server-api.js        # REST API + WebSocket /sync + раздача статики
├── server.js            # Отдельный WebSocket-сервер (npm run sync)
├── database.js          # Чтение/запись data/store.json
├── data/
│   ├── store.json       # Карта, пользователи, история, настройки
│   └── backups/         # Ежедневные бэкапы backup-YYYY-MM-DD.json (30 дней)
├── server-config.example.json
├── README.md
├── BUILD.md             # Сборка защищённой версии (обфускация)
├── IMPROVEMENTS.md      # Идеи по доработке
├── POSSIBLE_ISSUES.md   # Известные ограничения
└── LICENSE
```

## Технологии

- Яндекс.Карты API 2.1
- JavaScript (без фреймворков)
- CSS-переменные (темы), тёмная подложка карты через CSS-фильтр
- Сервер: Express, WebSocket (ws), хранение в JSON

## История изменений

- **1.0.3** — фильтр карты по типам объектов; фильтры истории (кто, действие, даты); начальная позиция карты по пользователю; автоматические ежедневные бэкапы (30 дней); кабели с опорами как промежуточными точками; удаление опоры с кабелем (с предупреждением); удалён тип «Медный кабель».
- **1.0.2** — (предыдущие изменения).
- **1.0.1** — базовая версия.

## Лицензия

Proprietary. Copyright (c) 2024–2026 Network-map. Подробнее см. [LICENSE](LICENSE).
